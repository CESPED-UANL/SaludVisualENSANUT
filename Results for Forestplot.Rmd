---
title: "Results for Forest Plot ENSANUT 2018"
author: "Luis E Segura"
date: "2023-01-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = FALSE, message = FALSE)
options(tinytex.verbose = TRUE)

rm(list = ls())

library(tidyverse)
library(haven)
library(skimr)
library(Amelia)
library(survey)
library(srvyr)
library(ggthemes)

options(scipen=999)

data <- read_sav(url("https://www.dropbox.com/s/550t3sjrs1r1u57/2022Ensanut2018.sav?dl=1"))

data <- data %>%
  rename_with(., .fn = tolower)


```

```{r, exploration}
skim(data)

grep("f_20", value = T, names(data))
grep("est", value = T, names(data))

```

```{r, survey design}

### some variable recoding
data <- data %>%
  mutate(dv_bin.fct = factor(dv_bin, labels = c("No Visual Disability", "Yes Visual Disability")), 
         sexo = factor(sexo, labels = c("Men", "Women")), 
         urbanicity = factor(dominio, labels = c("Urban", "Rural")), 
         age_cat = factor(ifelse(edad < 40, 1, 
                          ifelse(edad > 39 & edad < 60, 2, 3)), 
                          labels = c("20 - 39 yo", "40 - 59 yo", "60+ yo")), 
         region = factor(region, labels = c("North", "Center", "Mexico City", "South")), 
         ses = factor(case_when(estrato == 1 ~ 4, 
                         estrato == 2 ~ 3, 
                         estrato == 3 ~ 2, 
                         estrato == 4 ~ 1), labels = c("High", "Middle High", "Middle Low", "Low")),
         hta = factor(ifelse(p4_1 == 2, 0, p4_1), labels = c("No Hypertension", "Yes Hypertension")), 
         diabetes = factor(ifelse(p3_1 > 1, 0, p3_1), labels = c("No Diabetes", "Yes Diabetes")))

### setting the complex sample survey design object
design.ensanut <- data %>%
  as_survey_design(strata = est_dis, 
                   ids = upm_dis, 
                   weights = f_20mas, 
                   nest = T)

```

```{r, univariate logistic regression}
### saving the predictors names in a vector
myvars <- c("sexo", "urbanicity", "age_cat", "region", "ses", "hta", "diabetes")

### function to run a univariate logistic regression 
myfun <- function(x) {
  require(tidyverse)
  require(survey)
  require(srvyr)
  
  svyglm(as.formula(paste("dv_bin.fct ~", x)), design = design.ensanut, 
         family = quasibinomial(link = "logit")) %>%
    broom::tidy(exponentiate = T, conf.int = T) %>%
    filter(term !="(Intercept)") %>%
    rename(OR = estimate) %>%
    select(term, OR, conf.low, conf.high, p.value) %>%
    mutate_if(is.numeric, round, 2)
    
}

### create an empty list
mylist <- vector(mode = "list", length = length(myvars))


### loop to run the logistic regression on each correlate in myvars and save results into a list
for(i in seq_along(myvars)){
  mylist[[i]] <- myfun(myvars[i])
  
}

### reference values
ref_levels <- tibble(term = c("Men", "Urban", "20 - 39 yo", 
                              "North", "High", "No Hypertension", 
                              "No Diabetes"), 
                     OR = rep(1.00, 7), 
                     conf.low = rep(NA, 7), 
                     conf.high = rep(NA, 7),
                     p.value = rep(NA, 7))

### bind list of results with reference values
results <- ref_levels[1, ] %>%
  bind_rows(mylist[[1]]) %>%
  bind_rows(ref_levels[2, ]) %>%
  bind_rows(mylist[[2]]) %>%
  bind_rows(ref_levels[3, ]) %>%
  bind_rows(mylist[[3]]) %>%
  bind_rows(ref_levels[4, ]) %>%
  bind_rows(mylist[[4]]) %>%
  bind_rows(ref_levels[5, ]) %>%
  bind_rows(mylist[[5]]) %>%
  bind_rows(ref_levels[6, ]) %>%
  bind_rows(mylist[[6]]) %>%
  bind_rows(ref_levels[7, ]) %>%
  bind_rows(mylist[[7]])
  
### some recoding
results <- results %>%
  mutate(term = str_replace(term, "sexoWomen", "Women"), 
         term = str_replace(term, "urbanicityRural", "Rural"), 
         term = str_replace(term, "age_cat40 - 59 yo", "40 - 50 yo"), 
         term = str_replace(term, "age_cat60+ yo", "60 and older"), 
         term = str_replace(term, "regionCenter", "Center"), 
         term = str_replace(term, "regionMexico City", "Mexico City"),
         term = str_replace(term, "regionSouth", "South"),
         term = str_replace(term, "sesMiddle High", "Middle High"), 
         term = str_replace(term, "sesMiddle Low", "Middle Low"), 
         term = str_replace(term, "sesLow", "Low"), 
         term = str_replace(term, "htaYes Hypertension", "Yes Hypertension"), 
         term = str_replace(term, "diabetesYes Diabetes", "Yes Diabetes"))

results$term[results$term == "age_cat60+ yo"] <- "60+ yo"


### save results as CSV
write.csv(results, "results.csv") 

```

```{r, forestplot}

results %>%
  mutate(term =  factor(term), 
         conf.low = ifelse(is.na(conf.low), 1, conf.low), 
         conf.high = ifelse(is.na(conf.high), 1, conf.high), 
         p.value = ifelse(is.na(p.value), 1, p.value), 
         orden = seq(1, 19, 1), 
         color = factor(c(rep(1, 2), rep(2, 2), rep(3, 3), rep(4, 4), 
                   rep(5, 4), rep(6, 2), rep(7, 2)), 
                   labels = c("Sex", "Urbanicity", "Age group", 
                              "Region", "SES", "HBP", "T2DM"))) %>%
  ggplot(aes(y = reorder(ordered(term, levels = levels(term)), desc(orden)), 
             x = OR, xmin = conf.low, xmax = conf.high, color = color)) +
  geom_point(size = 5, shape = "diamond") +
  geom_errorbarh(height = 0.3) + 
  scale_x_continuous(limits = c(0.7, 10.00), breaks= seq(0.70, 10.0, 0.30), name = "Odds Ratio")  +
  geom_vline(xintercept = 1, color = "black", linetype = "solid", alpha = 0.5) +
  theme_calc() +
  theme(legend.position = "left", 
        legend.title = element_blank()) +
  labs(y = "")


ggsave("forestplot.pdf", width = 9, height = 6, device = "pdf", units = "in", dpi = 1800)

```
